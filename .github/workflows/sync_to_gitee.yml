name: Sync to Gitee

on:
  workflow_dispatch: {}
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Keep only whitelisted files for Gitee sync
        shell: bash
        run: |
          set -eux
          # 白名单：仅保留这些顶层文件；其余全部删除（.git 本身除外）。
          keep=(.git .gitignore .dockerignore Dockerfile README_GITEE.md download_model.py requirements.txt serve.py data.jsonl)

          shopt -s dotglob
          for path in ./*; do
            base=$(basename "$path")
            skip=false
            for k in "${keep[@]}"; do
              if [[ "$base" == "$k" ]]; then
                skip=true
                break
              fi
            done
            if [[ "$skip" == false ]]; then
              rm -rf "$path"
            fi
          done

          # 将 Gitee 专用 README 作为 README.md 同步到 Gitee。
          # 说明：GitHub 主仓库可保留自己的 README.md（完整开发文档），但同步到 Gitee 时只需评测所需的精简版。
          if [[ -f "README_GITEE.md" ]]; then
            mv -f README_GITEE.md README.md
          else
            echo "ERROR: README_GITEE.md not found in repo root. Please add/commit it before syncing."
            exit 1
          fi

          # 将删除操作加入暂存区，以便 push -f 时同步移除 Gitee 上的多余文件。
          git add -A

          # 重要：git push 只推送提交，不会推送暂存区/工作区。
          # 因此在 runner 上创建一次仅用于同步的提交，让 Gitee 接收到裁剪后的文件树。
          if ! git diff --cached --quiet; then
            git -c user.name='gitee-sync-bot' -c user.email='gitee-sync-bot@users.noreply.github.com' \
              commit -m 'chore: sync whitelisted files to gitee'
          fi

      - name: Setup SSH for Gitee
        shell: bash
        run: |
          set -eux
          mkdir -p ~/.ssh
          if [[ -z "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" ]]; then
            echo "ERROR: secrets.GITEE_SSH_PRIVATE_KEY is empty/missing."
            echo "Please configure it in GitHub repo Settings -> Secrets and variables -> Actions."
            exit 1
          fi
          printf '%s' "${{ secrets.GITEE_SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          for i in 1 2 3 4 5; do
            # 避免仅写入 ssh-rsa 导致 Host key verification failed（部分平台已禁用/弱化 rsa）。
            ssh-keyscan -t ed25519,ecdsa,rsa gitee.com >> ~/.ssh/known_hosts 2>/dev/null && break
            sleep 2
          done
          test -s ~/.ssh/known_hosts

      - name: Push to Gitee
        shell: bash
        run: |
          set -eux
          git remote add gitee git@gitee.com:yukinostuki/metax-demo.git || true
          git push -f gitee master:master
